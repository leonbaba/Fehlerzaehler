<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fehlerzähler mit Strafen & Einstellungen</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 10px; background: #f0f0f0; }
  h1, h2 { text-align: center; }
  button { margin: 5px; padding: 8px 15px; font-size: 16px; cursor: pointer; }
  .section { background: white; padding: 15px; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 0 5px #ccc; }
  label { display: block; margin-top: 8px; font-weight: bold; }
  input[type=text], input[type=number], textarea { width: 100%; padding: 6px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
  ul { list-style-type: none; padding: 0; }
  li { padding: 5px 0; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
  .list-controls button { margin-left: 5px; }
  .hidden { display: none; }
  nav { text-align: center; margin-bottom: 20px; }
  nav button { margin: 0 10px; }
  #output { white-space: pre-wrap; background: #eee; padding: 10px; border-radius: 6px; height: 150px; overflow-y: auto; }
</style>
</head>
<body>

<h1>Fehlerzähler & Strafen</h1>

<nav>
  <button id="btn-session">Session</button>
  <button id="btn-settings">Einstellungen</button>
</nav>

<div id="session-view" class="section">
  <h2>Session</h2>
  <p><b>Aktuelles Video:</b> <span id="current-video">–</span></p>
  <p><b>Fehlerpunkte:</b> <span id="points">0</span></p>
  
  <label for="error-select">Fehler hinzufügen:</label>
  <select id="error-select"></select>
  <button id="add-error-btn">Fehler hinzufügen</button>
  
  <button id="next-video-btn" style="margin-top:15px;">Nächstes Video ziehen</button>

  <h3>Vergebene Strafen:</h3>
  <ul id="penalties-list"></ul>
</div>

<div id="settings-view" class="section hidden">
  <h2>Einstellungen</h2>
  
  <div>
    <h3>Videos bearbeiten</h3>
    <ul id="videos-list"></ul>
    <button id="add-video-btn">Video hinzufügen</button>
  </div>
  
  <div>
    <h3>Fehler bearbeiten</h3>
    <ul id="errors-list"></ul>
    <button id="add-error-setting-btn">Fehler hinzufügen</button>
  </div>
  
  <div>
    <h3>Strafen bearbeiten</h3>
    <ul id="penalties-list-settings"></ul>
    <button id="add-penalty-btn">Strafe hinzufügen</button>
  </div>

  <button id="save-settings-btn" style="margin-top:20px; background:#4caf50; color:white;">Einstellungen speichern</button>
</div>

<script>
(() => {
  // Keys für LocalStorage
  const LS_VIDEOS = 'fz_videos';
  const LS_ERRORS = 'fz_errors';
  const LS_PENALTIES = 'fz_penalties';

  // Default-Daten
  const defaultVideos = [
    {id:1, name:'1. Masha & Merle'},
    {id:2, name:'2. Video 2'},
    {id:3, name:'3. Video 3'},
  ];
  const defaultErrors = [
    {id:1, name:'Fehler A', points:1},
    {id:2, name:'Fehler B', points:3},
    {id:3, name:'Fehler C', points:6},
  ];
  const defaultPenalties = [
    {id:1, name:'Strafe 1'},
    {id:2, name:'Strafe 2'},
    {id:3, name:'Strafe 3'},
  ];

  // State
  let videos = [];
  let errors = [];
  let penalties = [];

  let currentVideo = null;
  let points = 0;
  let assignedPenalties = [];

  // Views
  const sessionView = document.getElementById('session-view');
  const settingsView = document.getElementById('settings-view');

  // UI Elements
  const currentVideoSpan = document.getElementById('current-video');
  const pointsSpan = document.getElementById('points');
  const errorSelect = document.getElementById('error-select');
  const addErrorBtn = document.getElementById('add-error-btn');
  const nextVideoBtn = document.getElementById('next-video-btn');
  const penaltiesList = document.getElementById('penalties-list');

  const videosList = document.getElementById('videos-list');
  const errorsList = document.getElementById('errors-list');
  const penaltiesListSettings = document.getElementById('penalties-list-settings');

  const addVideoBtn = document.getElementById('add-video-btn');
  const addErrorSettingBtn = document.getElementById('add-error-setting-btn');
  const addPenaltyBtn = document.getElementById('add-penalty-btn');
  const saveSettingsBtn = document.getElementById('save-settings-btn');

  const btnSession = document.getElementById('btn-session');
  const btnSettings = document.getElementById('btn-settings');

  // Hilfsfunktionen LocalStorage laden & speichern
  function loadOrDefault(key, defaultVal) {
    try {
      const raw = localStorage.getItem(key);
      if(!raw) return defaultVal;
      return JSON.parse(raw);
    } catch {
      return defaultVal;
    }
  }
  function save(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
  }

  // Init: Daten laden
  function initData() {
    videos = loadOrDefault(LS_VIDEOS, defaultVideos);
    errors = loadOrDefault(LS_ERRORS, defaultErrors);
    penalties = loadOrDefault(LS_PENALTIES, defaultPenalties);
  }

  // UI-Updates

  // Session UI aktualisieren
  function updateSessionUI() {
    currentVideoSpan.textContent = currentVideo ? currentVideo.name : '–';
    pointsSpan.textContent = points;

    // Fehlerselect befüllen
    errorSelect.innerHTML = '';
    errors.forEach(e => {
      const option = document.createElement('option');
      option.value = e.id;
      option.textContent = `${e.name} (${e.points} Punkte)`;
      errorSelect.appendChild(option);
    });

    // Vergebene Strafen anzeigen
    penaltiesList.innerHTML = '';
    assignedPenalties.forEach(p => {
      const li = document.createElement('li');
      li.textContent = p.name;
      penaltiesList.appendChild(li);
    });
  }

  // Settings UI aktualisieren
  function updateSettingsUI() {
    // Videos
    videosList.innerHTML = '';
    videos.forEach(v => {
      videosList.appendChild(createEditableListItem(v, 'video'));
    });

    // Fehler
    errorsList.innerHTML = '';
    errors.forEach(e => {
      errorsList.appendChild(createEditableListItem(e, 'error'));
    });

    // Strafen
    penaltiesListSettings.innerHTML = '';
    penalties.forEach(p => {
      penaltiesListSettings.appendChild(createEditableListItem(p, 'penalty'));
    });
  }

  // Listenelement mit Editierfunktion erstellen
  function createEditableListItem(item, type) {
    const li = document.createElement('li');

    // Input Felder je nach Typ
    if(type === 'video') {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = item.name;
      input.style.flex = '1';
      input.onchange = () => {
        item.name = input.value;
      };
      li.appendChild(input);
    } else if(type === 'error') {
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = item.name;
      nameInput.style.flex = '2';
      nameInput.onchange = () => { item.name = nameInput.value; };

      const pointsInput = document.createElement('input');
      pointsInput.type = 'number';
      pointsInput.min = '1';
      pointsInput.value = item.points;
      pointsInput.style.width = '60px';
      pointsInput.style.marginLeft = '10px';
      pointsInput.onchange = () => {
        let val = parseInt(pointsInput.value);
        if(isNaN(val) || val < 1) val = 1;
        item.points = val;
        pointsInput.value = val;
      };

      li.style.display = 'flex';
      li.style.alignItems = 'center';
      li.appendChild(nameInput);
      li.appendChild(pointsInput);
    } else if(type === 'penalty') {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = item.name;
      input.style.flex = '1';
      input.onchange = () => {
        item.name = input.value;
      };
      li.appendChild(input);
    }

    // Löschen Button
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Löschen';
    delBtn.onclick = () => {
      if(confirm('Eintrag wirklich löschen?')) {
        if(type === 'video') {
          videos = videos.filter(v => v.id !== item.id);
          updateSettingsUI();
        } else if(type === 'error') {
          errors = errors.filter(e => e.id !== item.id);
          updateSettingsUI();
        } else if(type === 'penalty') {
          penalties = penalties.filter(p => p.id !== item.id);
          updateSettingsUI();
        }
      }
    };
    li.appendChild(delBtn);

    return li;
  }

  // Neue Einträge hinzufügen
  addVideoBtn.onclick = () => {
    const maxId = videos.length > 0 ? Math.max(...videos.map(v => v.id)) : 0;
    videos.push({id: maxId+1, name:'Neues Video'});
    updateSettingsUI();
  };
  addErrorSettingBtn.onclick = () => {
    const maxId = errors.length > 0 ? Math.max(...errors.map(e => e.id)) : 0;
    errors.push({id: maxId+1, name:'Neuer Fehler', points:1});
    updateSettingsUI();
  };
  addPenaltyBtn.onclick = () => {
    const maxId = penalties.length > 0 ? Math.max(...penalties.map(p => p.id)) : 0;
    penalties.push({id: maxId+1, name:'Neue Strafe'});
    updateSettingsUI();
  };

  // Einstellungen speichern
  saveSettingsBtn.onclick = () => {
    save(LS_VIDEOS, videos);
    save(LS_ERRORS, errors);
    save(LS_PENALTIES, penalties);
    alert('Einstellungen gespeichert!');
    updateSessionUI();
  };

  // Fehler hinzufügen in Session
  addErrorBtn.onclick = () => {
    const errId = parseInt(errorSelect.value);
    const err = errors.find(e => e.id === errId);
    if(!err) return;
    points += err.points;
    // Punkte bei >10 auf (Punkte-10)+1 setzen, also zyklisch ab 1
    if(points > 10) points = (points - 10) + 1;

    // Prüfen, ob Punkte >= 10 (für Strafe vergeben)
    if(points >= 10) {
      // Strafe zufällig auswählen
      if(penalties.length > 0) {
        const idx = Math.floor(Math.random() * penalties.length);
        assignedPenalties.push(penalties[idx]);
        alert(`Strafe vergeben: ${penalties[idx].name}`);
        // Punkte nach Strafe auf 0 zurücksetzen
        points = 0;
      }
    }

    updateSessionUI();
  };

  // Nächstes Video ziehen
  nextVideoBtn.onclick = () => {
    if(videos.length === 0) {
      alert('Keine Videos in der Liste.');
      return;
    }
    // Zufälliges Video auswählen
    const idx = Math.floor(Math.random() * videos.length);
    currentVideo = videos[idx];
    points = 0;
    assignedPenalties = [];
    updateSessionUI();
  };

  // View Umschalten
  btnSession.onclick = () => {
    sessionView.classList.remove('hidden');
    settingsView.classList.add('hidden');
  };
  btnSettings.onclick = () => {
    settingsView.classList.remove('hidden');
    sessionView.classList.add('hidden');
    updateSettingsUI();
  };

  // Initialisierung
  function init() {
    initData();
    btnSession.click();
    updateSessionUI();
  }

  init();
})();
</script>

</body>
</html>
